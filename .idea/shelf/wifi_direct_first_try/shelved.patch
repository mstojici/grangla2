Index: app/src/main/java/com/boardgame/miljac/grangla/BluetoothPlayerGamePlayActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.boardgame.miljac.grangla;\r\n\r\nimport static com.boardgame.miljac.grangla.music.MusicHelpers.getRandomInRange;\r\nimport static com.boardgame.miljac.grangla.music.MusicHelpers.normalizeIndex;\r\nimport static com.boardgame.miljac.grangla.music.MusicHelpers.oneMoreInTheEnd;\r\nimport static com.boardgame.miljac.grangla.music.MusicHelpers.onlyTrumpetEnd;\r\nimport static com.boardgame.miljac.grangla.music.MusicHelpers.turnSomeInstrumentOn;\r\n\r\nimport android.Manifest;\r\nimport android.annotation.SuppressLint;\r\nimport android.app.Activity;\r\nimport android.bluetooth.BluetoothAdapter;\r\nimport android.bluetooth.BluetoothDevice;\r\nimport android.bluetooth.BluetoothServerSocket;\r\nimport android.bluetooth.BluetoothSocket;\r\nimport android.content.BroadcastReceiver;\r\nimport android.content.Context;\r\nimport android.content.DialogInterface;\r\nimport android.content.Intent;\r\nimport android.content.IntentFilter;\r\nimport android.content.SharedPreferences;\r\nimport android.graphics.Color;\r\nimport android.graphics.drawable.ColorDrawable;\r\nimport android.os.Build;\r\nimport android.os.Bundle;\r\nimport android.os.Handler;\r\nimport android.os.ParcelUuid;\r\nimport android.support.v4.graphics.ColorUtils;\r\nimport android.support.v7.app.AlertDialog;\r\nimport android.support.v7.app.AppCompatActivity;\r\nimport android.text.InputFilter;\r\nimport android.text.InputType;\r\nimport android.util.Log;\r\nimport android.view.View;\r\nimport android.view.Window;\r\nimport android.view.WindowManager;\r\nimport android.widget.CompoundButton;\r\nimport android.widget.EditText;\r\nimport android.widget.ImageButton;\r\nimport android.widget.ProgressBar;\r\nimport android.widget.TextView;\r\nimport android.widget.Toast;\r\nimport android.widget.ToggleButton;\r\n\r\nimport java.io.IOException;\r\nimport java.nio.charset.StandardCharsets;\r\nimport java.util.Timer;\r\nimport java.util.TimerTask;\r\nimport java.util.UUID;\r\nimport java.util.concurrent.CopyOnWriteArrayList;\r\nimport java.util.concurrent.TimeUnit;\r\nimport java.util.concurrent.locks.Lock;\r\nimport java.util.concurrent.locks.LockSupport;\r\nimport java.util.concurrent.locks.ReentrantReadWriteLock;\r\n\r\npublic class BluetoothPlayerGamePlayActivity extends AppCompatActivity implements TableFragment.OnFieldSelectedListener {\r\n\r\n    private int currentApiVersion;\r\n    private TableView tableView;\r\n    private OtherPlayer otherPlayer = new OtherPlayer();\r\n    private TableViewRefreshing tableViewRefreshing = new TableViewRefreshing();\r\n    private UIPut uIPut = new UIPut();\r\n    Table table = new Table(3);\r\n    private TableFragment tableFragment;\r\n    public Boolean gameDone = false;\r\n    private Boolean gamePaused = false;\r\n    private Boolean muted = false;\r\n    private boolean firstTimeAnimatedProgress = true;\r\n    private EndDialog endDialog;\r\n\r\n    private Coordinates c;\r\n    Coordinates lastMoveO;\r\n    Coordinates lastMoveX;\r\n    double result = 50;\r\n    public long waitingTimeCircle = 3000;\r\n    long waitingMomentCircle = 0;\r\n    boolean allowCircle = true;\r\n    public long waitingTimeCross = 3000;\r\n    long waitingMomentCross = 0;\r\n    private long gameStartTime, currentTime, lastEventTime, pausedTime;\r\n    boolean allowCross = true;\r\n    private int level;\r\n    private int player1Image;\r\n    private int player2Image;\r\n    private int player1Color;\r\n    private int player2Color;\r\n    private int player1ColorDesaturated;\r\n    private int player2ColorDesaturated;\r\n    private SharedPreferences mPrefs;\r\n    boolean startCircleTime = false;\r\n    boolean startCrossTime = false;\r\n    private String levelString;\r\n\r\n    private boolean win = false;\r\n    private boolean lose = false;\r\n    private boolean isHighScore = false;\r\n\r\n    int[][] spaceHeading = new int[6][6];\r\n    private HighScoresHelper.HttpGetScoresAsyncTask getScoresTask;\r\n\r\n    ToggleButton soundToggle;\r\n    ImageButton imageButton;\r\n    ResultBarAnimation animResult;\r\n\r\n\r\n    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();\r\n    private final Lock r = rwl.readLock();\r\n    ProgressBar resultBar, resultBar2, circleBar, crossBar;\r\n    TextView textClock;\r\n\r\n    Thread otherPlayerThread;\r\n    Thread tableViewRefreshingThread;\r\n    Thread uIPutThread;\r\n\r\n    CopyOnWriteArrayList movesO = new CopyOnWriteArrayList();\r\n    CopyOnWriteArrayList movesX = new CopyOnWriteArrayList();\r\n\r\n    Thread musicPlayerThread;\r\n    Thread proxyThread;\r\n    MusicPlayer musicPlayer;\r\n\r\n    // Intent request codes\r\n    private static final int REQUEST_CONNECT_DEVICE_SECURE = 1;\r\n    private static final int REQUEST_CONNECT_DEVICE_INSECURE = 2;\r\n    private static final int REQUEST_ENABLE_BT = 3;\r\n    private BluetoothAdapter mBluetoothAdapter = null;\r\n    private BluetoothSocket granglaSocket;\r\n    AcceptThread acceptThread;\r\n    boolean server;\r\n    UUID granglaUuid = UUID.fromString(\"756bd856-5dea-4fc7-a53b-2c0c1159746a\");\r\n    GranglaBluetoothService bluetoothService;\r\n\r\n    boolean gameStarted = false;\r\n    boolean gameInited = false;\r\n    int stateSent = 0;\r\n    public boolean gameEndSignal = false;\r\n\r\n    private class TableViewRefreshing implements Runnable {\r\n        public void run() {\r\n            LockSupport.parkNanos(70_000_000);\r\n            while (!gameDone) {\r\n                if (gamePaused) continue;\r\n\r\n                uIPutThread = new Thread(uIPut);\r\n                runOnUiThread(uIPutThread);\r\n                if(server) {\r\n                    if(stateSent <= 0) {\r\n                        bluetoothService.sendTableState();\r\n                    } else {\r\n                        stateSent--;\r\n                    }\r\n                }\r\n                LockSupport.parkNanos(70_000_000);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Create a BroadcastReceiver for ACTION_FOUND.\r\n    private final BroadcastReceiver receiver = new BroadcastReceiver() {\r\n        @SuppressLint(\"MissingPermission\")\r\n        public void onReceive(Context context, Intent intent) {\r\n            if(granglaSocket != null) return;\r\n            String action = intent.getAction();\r\n            if (BluetoothDevice.ACTION_FOUND.equals(action)) {\r\n                // Discovery has found a device. Get the BluetoothDevice\r\n                // object and its info from the Intent.\r\n                BluetoothDevice device = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);\r\n\r\n                @SuppressLint(\"MissingPermission\")\r\n                String deviceName = device.getName() == null ? \"null\" : device.getName();\r\n                if(!deviceName.equals(\"grangla\")) return;\r\n                Log.d(\"grangladevice\", deviceName);\r\n                Log.d(\"grangladevice\", device.getAddress());\r\n\r\n                BluetoothSocket socket;\r\n                try {\r\n                    socket = device.createInsecureRfcommSocketToServiceRecord(granglaUuid);\r\n                    socket.connect();\r\n                    Log.d(\"grangladevice\", \"connected!!\");\r\n                    if(granglaSocket == null) {\r\n                        granglaSocket = socket;\r\n\r\n                        new Timer().schedule(new TimerTask() {\r\n                            @Override\r\n                            public void run() {\r\n                                server = false;\r\n                                startGame();\r\n                            }\r\n                        }, 1000);\r\n\r\n                        acceptThread.cancel();\r\n                        unregisterReceiver(receiver);\r\n                        mBluetoothAdapter.cancelDiscovery();\r\n                    } else {\r\n                        socket.close();\r\n                    }\r\n                } catch (Exception e) {\r\n                    Log.d(\"grangladevice\", e.getMessage());\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n\r\n    @SuppressLint(\"MissingPermission\")\r\n    @Override\r\n    public void onStart() {\r\n        super.onStart();\r\n\r\n        if (mBluetoothAdapter == null) {\r\n            return;\r\n        }\r\n\r\n        /*mBluetoothAdapter.setName(\"grangla\");\r\n        if (!mBluetoothAdapter.isEnabled()) {\r\n            Intent enableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);\r\n            startActivityForResult(enableIntent, REQUEST_ENABLE_BT);\r\n        }*/\r\n\r\n        /*Intent discoverableIntent =\r\n                new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);\r\n        discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 300);\r\n        startActivity(discoverableIntent);*/\r\n\r\n        acceptThread = new AcceptThread();\r\n\r\n        final Handler handler = new Handler();\r\n        handler.postDelayed(new Runnable() {\r\n            @Override\r\n            public void run() {\r\n                if(granglaSocket == null) {\r\n                    IntentFilter filter = new IntentFilter(BluetoothDevice.ACTION_FOUND);\r\n                    registerReceiver(receiver, filter);\r\n                    mBluetoothAdapter.cancelDiscovery();\r\n                    mBluetoothAdapter.startDiscovery();\r\n                }\r\n            }\r\n        }, getRandomInRange(1000, 11000));\r\n\r\n\r\n        Intent intent = getIntent();\r\n        level = intent.getIntExtra(\"mrm_LEVEL\", 50);\r\n\r\n        setPlayerImages(intent);\r\n\r\n        setVisualElements();\r\n        textClock.setText(\"Connecting bluetooth...\");\r\n        textClock.setTextColor(Color.WHITE);\r\n    }\r\n\r\n    public void startGame(){\r\n        if(gameInited) {\r\n            setResult(55);\r\n            finish();\r\n            return;\r\n        }\r\n\r\n        gameInited = true;\r\n\r\n        gameStartTime = System.currentTimeMillis();\r\n        lastEventTime = gameStartTime;\r\n        /*otherPlayerThread = new Thread(otherPlayer);\r\n        otherPlayerThread.start();*/\r\n\r\n        table.server = server;\r\n\r\n        bluetoothService = new GranglaBluetoothService(granglaSocket, this);\r\n\r\n        tableViewRefreshingThread = new Thread(tableViewRefreshing);\r\n        tableViewRefreshingThread.start();\r\n\r\n\r\n        musicPlayer = new MusicPlayer();\r\n        musicPlayer.server = server;\r\n        musicPlayer.bluetoothService = bluetoothService;\r\n\r\n        ThinMidiBluetoothProxy proxy = new ThinMidiBluetoothProxy(gameStartTime, musicPlayer.midiDriver, musicPlayer.bluetoothService);\r\n        bluetoothService.proxy = proxy;\r\n\r\n        if(muted){\r\n            musicPlayer.silence();\r\n        }\r\n\r\n        proxyThread = new Thread(bluetoothService.proxy);\r\n        proxyThread.start();\r\n\r\n        musicPlayerThread = new Thread(musicPlayer);\r\n        musicPlayer.setNoteDuration((long) (TableConfig.NOTE_DURATION_FACTOR * waitingTimeCross));\r\n        musicPlayerThread.start();\r\n\r\n        if (gamePaused) gameStartTime += System.currentTimeMillis() - pausedTime;\r\n        gamePaused = false;\r\n        gameStarted = true;\r\n    }\r\n\r\n\r\n    /*public void onActivityResult(int requestCode, int resultCode, Intent data) {\r\n        switch (requestCode) {\r\n            case REQUEST_ENABLE_BT:\r\n                // When the request to enable Bluetooth returns\r\n                if (resultCode == Activity.RESULT_OK) {\r\n                    // Bluetooth is now enabled, so set up a chat session\r\n                    //setupChat();\r\n                } else {\r\n                    // User did not enable Bluetooth or an error occurred\r\n                    Log.d(\"grangla\", \"BT not enabled\");\r\n                    this.finish();\r\n                }\r\n                break;\r\n        }\r\n    }*/\r\n\r\n    private class AcceptThread extends Thread {\r\n        private BluetoothServerSocket mmServerSocket = null;\r\n\r\n        @SuppressLint(\"MissingPermission\")\r\n        public AcceptThread() {\r\n            BluetoothServerSocket tmp = null;\r\n            try {\r\n                tmp = mBluetoothAdapter.listenUsingInsecureRfcommWithServiceRecord(\"grangla\", granglaUuid);\r\n            } catch (IOException e) {\r\n                Log.e(\"grangladevice\", \"Socket's listen() method failed\", e);\r\n                finish();\r\n                return;\r\n            }\r\n            mmServerSocket = tmp;\r\n            this.start();\r\n        }\r\n\r\n        @SuppressLint(\"MissingPermission\")\r\n        public void run() {\r\n            BluetoothSocket socket = null;\r\n            // Keep listening until exception occurs or a socket is returned.\r\n            while (granglaSocket == null) {\r\n                try {\r\n                    socket = mmServerSocket.accept(30000);\r\n                } catch (IOException e) {\r\n                    Log.e(\"grangladevice\", \"Socket's accept() method failed\", e);\r\n                    if(granglaSocket == null) {\r\n                        setResult(55);\r\n                        finish();\r\n                    }\r\n                    return;\r\n                }\r\n\r\n                if(granglaSocket != null){\r\n                    try {\r\n                        mmServerSocket.close();\r\n                    } catch (IOException e) {\r\n                        e.printStackTrace();\r\n                    }\r\n                    break;\r\n                }\r\n                if (socket != null) {\r\n                    if(granglaSocket == null) {\r\n                        granglaSocket = socket;\r\n\r\n                        new Timer().schedule(new TimerTask() {\r\n                            @Override\r\n                            public void run() {\r\n                                server = true;\r\n                                startGame();\r\n                            }\r\n                        }, 1000);\r\n\r\n                        unregisterReceiver(receiver);\r\n                        mBluetoothAdapter.cancelDiscovery();\r\n                        Log.d(\"grangladevice\", \"server connected!\");\r\n                    } else {\r\n                        try {\r\n                            socket.close();\r\n                        } catch (IOException e) {\r\n                            //e.printStackTrace();\r\n                        }\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Closes the connect socket and causes the thread to finish.\r\n        public void cancel() {\r\n            try {\r\n                mmServerSocket.close();\r\n            } catch (IOException e) {\r\n                Log.e(\"grangladevice\", \"Could not close the connect socket\", e);\r\n            }\r\n        }\r\n    }\r\n\r\n    /*@Override\r\n    protected void onPause() {\r\n        super.onPause();\r\n        musicPlayer.mute();\r\n        gamePaused = true;\r\n        pausedTime = System.currentTimeMillis();\r\n        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);\r\n        saveSharedPreferences();\r\n    }*/\r\n\r\n\r\n    @Override\r\n    protected void onResume() {\r\n        super.onResume();\r\n        getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);\r\n\r\n        /*if (musicPlayer == null) {\r\n            musicPlayer = new MusicPlayer();\r\n        }\r\n\r\n        if (!muted && !musicPlayer.isEndSong()) {\r\n            musicPlayer = new MusicPlayer();\r\n            musicPlayerThread = new Thread(musicPlayer);\r\n            musicPlayer.setNoteDuration((long) (TableConfig.NOTE_DURATION_FACTOR * waitingTimeCross));\r\n            musicPlayerThread.start();\r\n        }\r\n\r\n        if (gamePaused) gameStartTime += System.currentTimeMillis() - pausedTime;\r\n        gamePaused = false;*/\r\n    }\r\n\r\n\r\n    private void saveSharedPreferences() {\r\n        if (mPrefs == null) {\r\n            mPrefs = getSharedPreferences(\"mrm\", MODE_PRIVATE);\r\n        }\r\n        SharedPreferences.Editor ed = mPrefs.edit();\r\n        ed.putBoolean(\"mrm_SOUND\", soundToggle.isChecked());\r\n\r\n        ed.commit();\r\n    }\r\n\r\n    @Override\r\n    public void onSaveInstanceState(Bundle outState) {\r\n        saveSharedPreferences();\r\n        super.onSaveInstanceState(outState);\r\n    }\r\n\r\n    @Override\r\n    public void onRestoreInstanceState(Bundle inState) {\r\n        super.onRestoreInstanceState(inState);\r\n    }\r\n\r\n\r\n    private void setPlayerImages(Intent intent) {\r\n        player1Image = intent.getIntExtra(\"PLAYER1_IMG\", R.drawable.pin39);\r\n        player2Image = intent.getIntExtra(\"PLAYER2_IMG\", R.drawable.pin40);\r\n\r\n\r\n        this.table = new Table(level);\r\n\r\n        if (player1Image == R.drawable.pin39) {\r\n            player1Color = TableConfig.OKO_COLOR;\r\n            player1ColorDesaturated = TableConfig.OKO_COLOR_DESATURATED;\r\n        }\r\n        if (player1Image == R.drawable.pin40) {\r\n            player1Color = TableConfig.GUMB_COLOR;\r\n            player1ColorDesaturated = TableConfig.GUMB_COLOR_DESATURATED;\r\n        }\r\n        if (player1Image == R.drawable.pin42) {\r\n            player1Color = TableConfig.DJETELINA_COLOR;\r\n            player1ColorDesaturated = TableConfig.DJETELINA_COLOR_DESATURATED;\r\n        }\r\n        if (player1Image == R.drawable.pin43) {\r\n            player1Color = TableConfig.ZVIJEZDA_COLOR;\r\n            player1ColorDesaturated = TableConfig.ZVIJEZDA_COLOR_DESATURATED;\r\n        }\r\n\r\n        if (player2Image == R.drawable.pin39) {\r\n            player2Color = TableConfig.OKO_COLOR;\r\n            player2ColorDesaturated = TableConfig.OKO_COLOR_DESATURATED;\r\n        }\r\n        if (player2Image == R.drawable.pin40) {\r\n            player2Color = TableConfig.GUMB_COLOR;\r\n            player2ColorDesaturated = TableConfig.GUMB_COLOR_DESATURATED;\r\n        }\r\n        if (player2Image == R.drawable.pin42) {\r\n            player2Color = TableConfig.DJETELINA_COLOR;\r\n            player2ColorDesaturated = TableConfig.DJETELINA_COLOR_DESATURATED;\r\n        }\r\n        if (player2Image == R.drawable.pin43) {\r\n            player2Color = TableConfig.ZVIJEZDA_COLOR;\r\n            player2ColorDesaturated = TableConfig.ZVIJEZDA_COLOR_DESATURATED;\r\n        }\r\n    }\r\n\r\n    private void setVisualElements() {\r\n        textClock = (TextView) findViewById(R.id.text_clock);\r\n        textClock.setShadowLayer(2, 0, 0, Color.WHITE);\r\n\r\n        resultBar = (ProgressBar) findViewById(R.id.result_bar);\r\n        resultBar.setProgress(50);\r\n        resultBar.getProgressDrawable().setColorFilter(player2Color,\r\n                android.graphics.PorterDuff.Mode.SRC_IN);\r\n        resultBar2 = (ProgressBar) findViewById(R.id.result_bar2);\r\n        resultBar2.setProgress(50);\r\n        resultBar2.getProgressDrawable().setColorFilter(player1Color,\r\n                android.graphics.PorterDuff.Mode.SRC_IN);\r\n\r\n\r\n        circleBar = (ProgressBar) findViewById(R.id.circle_time_bar);\r\n        circleBar.setProgress(100);\r\n        circleBar.invalidate();\r\n        circleBar.getProgressDrawable().setColorFilter(\r\n                player1Color & 0xA0FFFFFF,\r\n                android.graphics.PorterDuff.Mode.SRC_IN);\r\n        crossBar = (ProgressBar) findViewById(R.id.cross_time_bar);\r\n        crossBar.setProgress(100);\r\n        crossBar.invalidate();\r\n        crossBar.getProgressDrawable().setColorFilter(\r\n                player2Color & 0xA0FFFFFF,\r\n                android.graphics.PorterDuff.Mode.SRC_IN);\r\n\r\n        tableFragment = (TableFragment)\r\n                getSupportFragmentManager().findFragmentById(R.id.Table);\r\n        tableView = tableFragment.tableView;\r\n\r\n\r\n        if (mPrefs == null) {\r\n            mPrefs = getSharedPreferences(\"mrm\", MODE_PRIVATE);\r\n        }\r\n\r\n        soundToggle = (ToggleButton) findViewById(R.id.toggle_sound_button);\r\n\r\n\r\n        if ((mPrefs.getBoolean(\"mrm_SOUND\", true))) {\r\n            soundToggle.setChecked(true);\r\n        } else {\r\n            if (musicPlayer != null) {\r\n                musicPlayer.mute();\r\n            }\r\n            musicPlayer = new MusicPlayer();\r\n            musicPlayerThread = new Thread(musicPlayer);\r\n            musicPlayer.setNoteDuration((long) (TableConfig.NOTE_DURATION_FACTOR * waitingTimeCross));\r\n            muted = true;\r\n        }\r\n\r\n        soundToggle.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {\r\n            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {\r\n                if(!gameStarted) {\r\n                    muted = !isChecked;\r\n                    return;\r\n                }\r\n                if (isChecked) {\r\n                    musicPlayer.unsilence();\r\n                    muted = false;\r\n                } else {\r\n                    musicPlayer.silence();\r\n                    muted = true;\r\n                }\r\n            }\r\n        });\r\n\r\n\r\n        imageButton = (ImageButton) findViewById(R.id.discard_button);\r\n\r\n        imageButton.setOnClickListener(new View.OnClickListener() {\r\n\r\n            @Override\r\n            public void onClick(View arg0) {\r\n                saveSharedPreferences();\r\n                if (bluetoothService != null) {\r\n                    bluetoothService.sendExit();\r\n                }\r\n                finish();\r\n\r\n            }\r\n        });\r\n\r\n    }\r\n\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n\r\n        this.requestPermissions(new String[]{Manifest.permission.BLUETOOTH,\r\n                Manifest.permission.BLUETOOTH_ADMIN,\r\n                Manifest.permission.ACCESS_COARSE_LOCATION,\r\n                Manifest.permission.ACCESS_FINE_LOCATION,\r\n                Manifest.permission.BLUETOOTH_CONNECT,\r\n                Manifest.permission.BLUETOOTH_SCAN\r\n        }, 1000);\r\n\r\n        // Get local Bluetooth adapter\r\n        mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();\r\n/*\r\n        // If the adapter is null, then Bluetooth is not supported\r\n\r\n        if (mBluetoothAdapter == null) {\r\n            Toast.makeText(this.getBaseContext(), \"Bluetooth is not available\", Toast.LENGTH_LONG).show();\r\n            this.finish();\r\n        }*/\r\n\r\n        currentApiVersion = Build.VERSION.SDK_INT;\r\n        setContentView(R.layout.activity_game_play);\r\n\r\n\r\n    }\r\n\r\n\r\n    @Override\r\n    public void onWindowFocusChanged(boolean hasFocus) {\r\n        super.onWindowFocusChanged(hasFocus);\r\n        if (currentApiVersion >= Build.VERSION_CODES.KITKAT) {\r\n            getWindow().getDecorView().setSystemUiVisibility(\r\n                    View.SYSTEM_UI_FLAG_LAYOUT_STABLE\r\n                            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\r\n                            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\r\n                            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\r\n                            | View.SYSTEM_UI_FLAG_FULLSCREEN\r\n                            | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);\r\n        }\r\n    }\r\n\r\n    @SuppressLint(\"MissingPermission\")\r\n    @Override\r\n    protected void onDestroy() {\r\n        super.onDestroy();\r\n\r\n        saveSharedPreferences();\r\n\r\n        if (endDialog != null)\r\n            endDialog.dismiss();\r\n\r\n        gameDone = true;\r\n        if(musicPlayer != null) musicPlayer.mute();\r\n\r\n        /*try {\r\n            otherPlayerThread.join();\r\n        } catch (InterruptedException e) {\r\n            //e.printStackTrace();\r\n        }\r\n        otherPlayerThread = null;*/\r\n\r\n        try {\r\n            if(tableViewRefreshingThread!= null)\r\n                tableViewRefreshingThread.join();\r\n        } catch (InterruptedException e) {\r\n            //e.printStackTrace();\r\n        }\r\n        tableViewRefreshingThread = null;\r\n\r\n\r\n        try {\r\n            if(musicPlayerThread!= null)\r\n                musicPlayerThread.join();\r\n        } catch (InterruptedException e) {\r\n            //e.printStackTrace();\r\n        }\r\n        musicPlayerThread = null;\r\n\r\n        mBluetoothAdapter.cancelDiscovery();\r\n        try {\r\n            unregisterReceiver(receiver);\r\n        } catch (IllegalArgumentException e) {\r\n\r\n        }\r\n        acceptThread.cancel();\r\n        try {\r\n            if (granglaSocket != null)\r\n                granglaSocket.close();\r\n        } catch (IOException e) {\r\n            //e.printStackTrace();\r\n        }\r\n\r\n        if(bluetoothService != null)\r\n            bluetoothService.cancel();\r\n    }\r\n\r\n    public void onFieldSelected(int x,int y) {\r\n        if(!gameStarted) return;\r\n        synchronized (table) {\r\n            if(allowCircle) {\r\n                if(!server){\r\n                    if(this.table.get(x, y) == State.empty) {\r\n                        bluetoothService.sendMove(x, y);\r\n                    }\r\n                } else {\r\n                    if (this.table.publicPut(State.circle, x, y)) {\r\n                        lastMoveO = new Coordinates(x, y);\r\n                        waitingMomentCircle = System.currentTimeMillis() + waitingTimeCircle;\r\n                        startCircleTime = true;\r\n                        allowCircle = false;\r\n                        movesO.add(0, lastMoveO);\r\n\r\n                        if (!server) {\r\n                            bluetoothService.sendMove(x, y);\r\n                        } else {\r\n                            bluetoothService.sendTableState();\r\n                            stateSent = 1;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n        }\r\n    }\r\n\r\n\r\n    class UIPut implements Runnable {\r\n\r\n        private void updateTableViewFields(){\r\n\r\n            for (int i = 0; i < TableConfig.TABLE_SIZE; i++) {\r\n                for (int j = 0; j < TableConfig.TABLE_SIZE; j++) {\r\n                    if (table.publicGet(i, j) == State.circle) {\r\n                        if ((movesO.size() >= (TableConfig.MAX_PIECES-1)) &&\r\n                                (new Coordinates(i,j).equals(movesO.get(TableConfig.MAX_PIECES - 2)))) {\r\n                            tableView.changePinColor(i, j, player1Image, 0.32f);\r\n                        }\r\n                        else if ((movesO.size() >= (TableConfig.MAX_PIECES-2)) &&\r\n                                (new Coordinates(i,j).equals(movesO.get(TableConfig.MAX_PIECES - 3)))) {\r\n                            tableView.changePinColor(i, j, player1Image, 0.6f);\r\n                        }\r\n                        else {\r\n                            tableView.changePinColor(i, j, player1Image, 1f);\r\n                        }\r\n                    }\r\n                    if (table.publicGet(i, j) == State.cross){\r\n                        if ((movesX.size() >= (TableConfig.MAX_PIECES-1)) &&\r\n                                (new Coordinates(i,j).equals(movesX.get(TableConfig.MAX_PIECES - 2)))) {\r\n                            tableView.changePinColor(i, j, player2Image, 0.32f);\r\n                        }\r\n                        else if ((movesX.size() >= (TableConfig.MAX_PIECES-2)) &&\r\n                                (new Coordinates(i,j)).equals(movesX.get(TableConfig.MAX_PIECES - 3))) {\r\n                            tableView.changePinColor(i, j, player2Image, 0.6f);\r\n                        }\r\n                        else {\r\n                            tableView.changePinColor(i, j, player2Image, 1f);\r\n                        }\r\n\r\n                    }\r\n                    if (table.publicGet(i, j) == State.empty) {\r\n                        tableView.changePinColor(i, j, R.drawable.pin41, 1f, spaceHeading[normalizeIndex(i)][normalizeIndex(j)]);\r\n\r\n                        movesO.remove(new Coordinates(i, j));\r\n                        movesX.remove(new Coordinates(i, j));\r\n                    }\r\n\r\n                    if (table.publicGet(i, j) == State.rock) {\r\n                        tableView.changePinColor(i, j, R.drawable.pin20, 1f);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        private void checkIfScored(){\r\n            if(server)\r\n                spaceHeading = new int[6][6];\r\n\r\n            if ((lastMoveO != null) && (table != null) && (movesO != null)) {\r\n                double r = 0;\r\n                r = table.getScore(lastMoveO.x, lastMoveO.y, lastEventTime, spaceHeading);\r\n                if(server)\r\n                    result += r * TableConfig.RESULT_FACTOR;\r\n                if (r == 0){\r\n                    if(movesO.size() >= TableConfig.MAX_PIECES) {\r\n                        Coordinates c = (Coordinates) movesO.remove(TableConfig.MAX_PIECES - 1);\r\n                        table.publicEmpty(c.x, c.y);\r\n                        tableView.removeImediately(c.x, c.y);\r\n                        spaceHeading[c.x][c.y] = -2;\r\n                        if(server)\r\n                            result -= 3 * TableConfig.RESULT_FACTOR;\r\n                    }\r\n                } else {\r\n                    lastEventTime = System.currentTimeMillis();\r\n                    turnSomeInstrumentOn();\r\n                }\r\n                lastMoveO = null;\r\n            }\r\n\r\n            if ((lastMoveX != null) && (table != null) && (movesX != null)) {\r\n                double r = 0;\r\n                r = table.getScore(lastMoveX.x, lastMoveX.y, lastEventTime, spaceHeading);\r\n                if(server)\r\n                    result -= r * TableConfig.RESULT_FACTOR;\r\n                if (r == 0){\r\n                    if(movesX.size() >= TableConfig.MAX_PIECES) {\r\n                        Coordinates c = (Coordinates) movesX.remove(TableConfig.MAX_PIECES - 1);\r\n                        table.publicEmpty(c.x, c.y);\r\n                        tableView.removeImediately(c.x, c.y);\r\n                        spaceHeading[c.x][c.y] = -2;\r\n                        if(server)\r\n                            result += 3 * TableConfig.RESULT_FACTOR;\r\n                    }\r\n                } else {\r\n                    lastEventTime = System.currentTimeMillis();\r\n                    turnSomeInstrumentOn();\r\n                }\r\n                lastMoveX = null;\r\n            }\r\n            /*if(!server)\r\n                spaceHeading = new int[6][6];*/\r\n        }\r\n\r\n        private void checkIfGameEnded() {\r\n            long gameEndTime = System.currentTimeMillis() - gameStartTime;\r\n\r\n            if ((server && ((result <= 0) ||\r\n                    (result >= 100))) ||\r\n                    gameEndSignal) {\r\n\r\n                if(server){\r\n                    bluetoothService.sendWin();\r\n                }\r\n\r\n                gameDone = true;\r\n\r\n                onlyTrumpetEnd();\r\n\r\n                updateTableViewFields();\r\n                checkIfScored();\r\n                refreshResultBar();\r\n\r\n                //musicPlayer.setMeasure(2);\r\n                musicPlayer.setEndSong();\r\n\r\n                endDialog = new EndDialog(BluetoothPlayerGamePlayActivity.this, R.style.EndDialog);\r\n                endDialog.getWindow().requestFeature(Window.FEATURE_NO_TITLE);\r\n                endDialog.getWindow().setBackgroundDrawable(new ColorDrawable(Color.TRANSPARENT));\r\n                endDialog.setCanceledOnTouchOutside(false);\r\n\r\n                endDialog.getWindow().addFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN);\r\n\r\n                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\r\n                    endDialog.getWindow().getDecorView().setSystemUiVisibility(\r\n                            View.SYSTEM_UI_FLAG_LAYOUT_STABLE\r\n                                    | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\r\n                                    | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\r\n                                    | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\r\n                                    | View.SYSTEM_UI_FLAG_FULLSCREEN\r\n                                    | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);\r\n                }\r\n\r\n                if (result <= 50) {\r\n                    if (player2Image == R.drawable.pin39) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_oko, null));\r\n                    }\r\n                    if (player2Image == R.drawable.pin40) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_gumb, null));\r\n                    }\r\n                    if (player2Image == R.drawable.pin42) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_djetelina, null));\r\n                    }\r\n                    if (player2Image == R.drawable.pin43) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_zvijezda, null));\r\n                    }\r\n                } else {\r\n                    if (player1Image == R.drawable.pin39) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_oko, null));\r\n                    }\r\n                    if (player1Image == R.drawable.pin40) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_gumb, null));\r\n                    }\r\n                    if (player1Image == R.drawable.pin42) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_djetelina, null));\r\n                    }\r\n                    if (player1Image == R.drawable.pin43) {\r\n                        endDialog.setContentView(getLayoutInflater().inflate(R.layout.end_dialog_zvijezda, null));\r\n                    }\r\n                }\r\n\r\n                Handler handlerAnimation1 = new Handler();\r\n                handlerAnimation1.postDelayed(new Runnable() {\r\n                    public void run() {\r\n                        oneMoreInTheEnd();\r\n                        endDialog.show();\r\n                    }\r\n                }, 1000);\r\n\r\n                Handler handlerAnimation2 = new Handler();\r\n                handlerAnimation2.postDelayed(new Runnable() {\r\n                    public void run() {\r\n                        endDialog.dismiss();\r\n\r\n                        if (result >= 0) {\r\n                            win = true;\r\n                        } else {\r\n                            lose = true;\r\n                        }\r\n\r\n                        if((levelString == null) || !getScoresTask.isHighScore()){\r\n                            finish();\r\n                        }\r\n                    }\r\n                }, 7000);\r\n\r\n                Handler handlerIsHighScore = new Handler();\r\n                handlerIsHighScore.postDelayed(new Runnable() {\r\n                    public void run() {\r\n                        if(levelString == null) return;\r\n                        getScoresTask = new HighScoresHelper.HttpGetScoresAsyncTask(levelString, (long)(Math.signum(result))*gameEndTime);\r\n                        getScoresTask.execute(\"\");\r\n                    }}, 0);\r\n\r\n                Handler handlerSendHighScore = new Handler();\r\n                handlerSendHighScore.postDelayed(new Runnable() {\r\n                    public void run() {\r\n                        if(levelString == null) return;\r\n                        if(!getScoresTask.isHighScore()){\r\n                            return;\r\n                        }\r\n                        AlertDialog.Builder builder = new AlertDialog.Builder(BluetoothPlayerGamePlayActivity.this);\r\n                        builder.setTitle(\"High Score\");\r\n                        builder.setInverseBackgroundForced(true);\r\n                        builder.setMessage(\"Please enter your name:\");\r\n                        final EditText input = new EditText(BluetoothPlayerGamePlayActivity.this);\r\n                        input.setInputType(InputType.TYPE_TEXT_FLAG_CAP_WORDS);\r\n                        input.setFilters(new InputFilter[] { new InputFilter.LengthFilter(25) });\r\n                        builder.setView(input);\r\n                        builder.setCancelable(false);\r\n                        builder.setPositiveButton(\"OK\", new DialogInterface.OnClickListener() {\r\n                            @Override\r\n                            public void onClick(DialogInterface dialog, int which) {\r\n                                String name = input.getText().toString();\r\n                                new HighScoresHelper.HttpPostScoreAsyncTask(new Score(levelString, (long)(Math.signum(result))*gameEndTime, name)).execute(\"\");\r\n                                finish();\r\n                            }\r\n                        });\r\n                        builder.setNegativeButton(\"Cancel\", new DialogInterface.OnClickListener() {\r\n                            @Override\r\n                            public void onClick(DialogInterface dialog, int which) {\r\n                                dialog.cancel();\r\n                                finish();\r\n                            }\r\n                        });\r\n\r\n                        builder.show();\r\n\r\n                    }\r\n\r\n                }, 3000);\r\n            }\r\n        }\r\n\r\n        public void refreshResultBar(){\r\n            long millis = (System.currentTimeMillis() - gameStartTime);\r\n            textClock.setText(String.format(\"%d:%02d\",\r\n                    TimeUnit.MILLISECONDS.toMinutes(millis),\r\n                    TimeUnit.MILLISECONDS.toSeconds(millis) -\r\n                            TimeUnit.MINUTES.toSeconds(TimeUnit.MILLISECONDS.toMinutes(millis))));\r\n            if(result<50){\r\n                textClock.setTextColor(ColorUtils.blendARGB(Color.WHITE, player2Color, (float)(50-result)/50));\r\n            } else {\r\n                textClock.setTextColor(ColorUtils.blendARGB(Color.WHITE, player1Color, (float) (result - 50) / 50));\r\n            }\r\n\r\n            if(!firstTimeAnimatedProgress)\r\n                if (gameDone){\r\n                    resultBar.clearAnimation();\r\n                    if(result > 50) {\r\n                        animResult = new ResultBarAnimation(resultBar2, resultBar, (float) 100);\r\n                    } else {\r\n                        animResult = new ResultBarAnimation(resultBar2, resultBar, (float) 0);\r\n                    }\r\n                    animResult.setDuration(100);\r\n                    resultBar.startAnimation(animResult);\r\n                } else {\r\n                    if ((animResult.hasEnded()) && (resultBar2.getProgress() != (int) result)) {\r\n                        animResult = new ResultBarAnimation(resultBar2, resultBar, (float) result);\r\n                        animResult.setDuration(400);\r\n                        resultBar.startAnimation(animResult);\r\n                    }\r\n                }\r\n\r\n            if(firstTimeAnimatedProgress) {\r\n                animResult = new ResultBarAnimation(resultBar, resultBar2, (float) result);\r\n                animResult.setDuration(100);\r\n                resultBar.startAnimation(animResult);\r\n\r\n                firstTimeAnimatedProgress = false;\r\n            }\r\n        }\r\n\r\n        private void refreshWaitingTimeValues(){\r\n            if(!(currentTime < waitingMomentCircle)){\r\n                allowCircle = true;\r\n            }\r\n\r\n            if(!(currentTime < waitingMomentCross)){\r\n                allowCross = true;\r\n            }\r\n\r\n            if(startCircleTime) {\r\n                TimerAnimation anim = new TimerAnimation(circleBar,\r\n                        player1Color & 0xC5FFFFFF,\r\n                        player1ColorDesaturated & 0x80FFFFFF);\r\n                anim.setDuration(waitingMomentCircle - currentTime);\r\n                circleBar.startAnimation(anim);\r\n                startCircleTime = false;\r\n            }\r\n\r\n            if(startCrossTime) {\r\n                TimerAnimation anim2 = new TimerAnimation(crossBar,\r\n                        player2Color & 0xC5FFFFFF,\r\n                        player2ColorDesaturated & 0x80FFFFFF);\r\n                anim2.setDuration(waitingMomentCross - currentTime);\r\n                crossBar.startAnimation(anim2);\r\n                startCrossTime = false;\r\n            }\r\n\r\n            if(server) {\r\n                waitingTimeCircle = TableConfig.MAX_WAITING_TIME - (TableConfig.MAX_WAITING_TIME - TableConfig.MIN_WAITING_TIME) / 50 * Math.abs(50 - (int) result);\r\n                waitingTimeCircle -= TableConfig.MIN_WAITING_TIME;\r\n                waitingTimeCircle = (long) ((double) waitingTimeCircle / (1 + (double) (currentTime - gameStartTime) / (double) TableConfig.HALF_LIFE));\r\n                waitingTimeCircle += TableConfig.MIN_WAITING_TIME;\r\n\r\n                waitingTimeCross = TableConfig.MAX_WAITING_TIME - (TableConfig.MAX_WAITING_TIME - TableConfig.MIN_WAITING_TIME) / 50 * Math.abs(50 - (int) result);\r\n                waitingTimeCross -= TableConfig.MIN_WAITING_TIME;\r\n                waitingTimeCross = (long) ((double) waitingTimeCross / (1 + (double) (currentTime - gameStartTime) / (double) TableConfig.HALF_LIFE));\r\n                waitingTimeCross += TableConfig.MIN_WAITING_TIME;\r\n            }\r\n        }\r\n\r\n        //music measure and speed are changed according to waitingTime, that is game speed\r\n        private void refreshMusicPlayerValues(){\r\n            if(!musicPlayer.isEndSong()) {\r\n                musicPlayer.setNoteDuration((long)(TableConfig.NOTE_DURATION_FACTOR * waitingTimeCross));\r\n            }\r\n        }\r\n\r\n\r\n        public void run() {\r\n            synchronized(BluetoothPlayerGamePlayActivity.this) {\r\n                currentTime = System.currentTimeMillis();\r\n\r\n                checkIfGameEnded();\r\n                updateTableViewFields();\r\n                checkIfScored();\r\n                refreshResultBar();\r\n                refreshWaitingTimeValues();\r\n                refreshMusicPlayerValues();\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n    private class OtherPlayer implements Runnable {\r\n        private void thinkForAWhile(){\r\n            try {\r\n                double a = Math.random();\r\n                a*= (0.7 + 0.42/50 * Math.abs(50 - (int)result));\r\n                Thread.sleep(waitingTimeCross +\r\n                        (long)(a*( (TableConfig.THINKING_TIME_MIN_LEVEL - TableConfig.THINKING_TIME_MAX_LEVEL) * (101-level) / 100 + TableConfig.THINKING_TIME_MAX_LEVEL)));\r\n            } catch (InterruptedException e) {\r\n                //e.printStackTrace();\r\n            }\r\n\r\n            if ((currentTime - lastEventTime) < 90){\r\n                try {\r\n                    Thread.sleep(90);\r\n                } catch (InterruptedException e) {\r\n                    //e.printStackTrace();\r\n                }\r\n            }\r\n        }\r\n\r\n        public void run() {\r\n            while(!gameDone){\r\n                thinkForAWhile();\r\n\r\n                if(gamePaused) continue;\r\n\r\n                synchronized (table) {\r\n                    c = table.makeAMove(State.cross);\r\n                    lastMoveX = new Coordinates(c.x, c.y);\r\n                    waitingMomentCross = System.currentTimeMillis() + waitingTimeCross;\r\n                    startCrossTime = true;\r\n                    allowCross = false;\r\n                    movesX.add(0, lastMoveX);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/boardgame/miljac/grangla/BluetoothPlayerGamePlayActivity.java b/app/src/main/java/com/boardgame/miljac/grangla/BluetoothPlayerGamePlayActivity.java
--- a/app/src/main/java/com/boardgame/miljac/grangla/BluetoothPlayerGamePlayActivity.java	(revision 4125073d686ed5e4008d23ffa629e652f1e331ea)
+++ b/app/src/main/java/com/boardgame/miljac/grangla/BluetoothPlayerGamePlayActivity.java	(date 1674405153891)
@@ -1,5 +1,6 @@
 package com.boardgame.miljac.grangla;
 
+import static android.Manifest.*;
 import static com.boardgame.miljac.grangla.music.MusicHelpers.getRandomInRange;
 import static com.boardgame.miljac.grangla.music.MusicHelpers.normalizeIndex;
 import static com.boardgame.miljac.grangla.music.MusicHelpers.oneMoreInTheEnd;
@@ -19,8 +20,11 @@
 import android.content.Intent;
 import android.content.IntentFilter;
 import android.content.SharedPreferences;
+import android.content.pm.PackageManager;
 import android.graphics.Color;
 import android.graphics.drawable.ColorDrawable;
+import android.net.wifi.p2p.WifiP2pDeviceList;
+import android.net.wifi.p2p.WifiP2pManager;
 import android.os.Build;
 import android.os.Bundle;
 import android.os.Handler;
@@ -135,6 +139,12 @@
     int stateSent = 0;
     public boolean gameEndSignal = false;
 
+    private final int PERMISSION_REQUEST_CODE = 1000;
+
+    private final IntentFilter intentFilter = new IntentFilter();
+    WifiP2pManager.Channel channel;
+    WifiP2pManager manager;
+
     private class TableViewRefreshing implements Runnable {
         public void run() {
             LockSupport.parkNanos(70_000_000);
@@ -155,47 +165,38 @@
         }
     }
 
-    // Create a BroadcastReceiver for ACTION_FOUND.
     private final BroadcastReceiver receiver = new BroadcastReceiver() {
         @SuppressLint("MissingPermission")
         public void onReceive(Context context, Intent intent) {
-            if(granglaSocket != null) return;
             String action = intent.getAction();
-            if (BluetoothDevice.ACTION_FOUND.equals(action)) {
-                // Discovery has found a device. Get the BluetoothDevice
-                // object and its info from the Intent.
-                BluetoothDevice device = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);
-
-                @SuppressLint("MissingPermission")
-                String deviceName = device.getName() == null ? "null" : device.getName();
-                if(!deviceName.equals("grangla")) return;
-                Log.d("grangladevice", deviceName);
-                Log.d("grangladevice", device.getAddress());
-
-                BluetoothSocket socket;
-                try {
-                    socket = device.createInsecureRfcommSocketToServiceRecord(granglaUuid);
-                    socket.connect();
-                    Log.d("grangladevice", "connected!!");
-                    if(granglaSocket == null) {
-                        granglaSocket = socket;
-
-                        new Timer().schedule(new TimerTask() {
-                            @Override
-                            public void run() {
-                                server = false;
-                                startGame();
-                            }
-                        }, 1000);
-
-                        acceptThread.cancel();
-                        unregisterReceiver(receiver);
-                        mBluetoothAdapter.cancelDiscovery();
-                    } else {
-                        socket.close();
+            Log.d("granglawifi","action received: " + action);
+            if (WifiP2pManager.WIFI_P2P_STATE_CHANGED_ACTION.equals(action)) {
+                // Determine if Wi-Fi Direct mode is enabled or not, alert
+                // the Activity.
+                /*int state = intent.getIntExtra(WifiP2pManager.EXTRA_WIFI_STATE, -1);
+                if (state == WifiP2pManager.WIFI_P2P_STATE_ENABLED) {
+                    activity.setIsWifiP2pEnabled(true);
+                } else {
+                    activity.setIsWifiP2pEnabled(false);
+                }*/
+            } else if (WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION.equals(action)) {
+
+                // Connection state changed! We should probably do something about
+                // that.
+
+            } else if (WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION.equals(action)) {
+                WifiP2pManager.PeerListListener myPeerListListener = new WifiP2pManager.PeerListListener(){
+
+                    @Override
+                    public void onPeersAvailable(WifiP2pDeviceList wifiP2pDeviceList) {
+                        Log.d("granglawifi", wifiP2pDeviceList.toString());
                     }
-                } catch (Exception e) {
-                    Log.d("grangladevice", e.getMessage());
+                };
+                // request available peers from the wifi p2p manager. This is an
+                // asynchronous call and the calling activity is notified with a
+                // callback on PeerListListener.onPeersAvailable()
+                if (manager != null) {
+                    manager.requestPeers(channel, myPeerListListener);
                 }
             }
         }
@@ -207,37 +208,6 @@
     public void onStart() {
         super.onStart();
 
-        if (mBluetoothAdapter == null) {
-            return;
-        }
-
-        /*mBluetoothAdapter.setName("grangla");
-        if (!mBluetoothAdapter.isEnabled()) {
-            Intent enableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
-            startActivityForResult(enableIntent, REQUEST_ENABLE_BT);
-        }*/
-
-        /*Intent discoverableIntent =
-                new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);
-        discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 300);
-        startActivity(discoverableIntent);*/
-
-        acceptThread = new AcceptThread();
-
-        final Handler handler = new Handler();
-        handler.postDelayed(new Runnable() {
-            @Override
-            public void run() {
-                if(granglaSocket == null) {
-                    IntentFilter filter = new IntentFilter(BluetoothDevice.ACTION_FOUND);
-                    registerReceiver(receiver, filter);
-                    mBluetoothAdapter.cancelDiscovery();
-                    mBluetoothAdapter.startDiscovery();
-                }
-            }
-        }, getRandomInRange(1000, 11000));
-
-
         Intent intent = getIntent();
         level = intent.getIntExtra("mrm_LEVEL", 50);
 
@@ -246,6 +216,21 @@
         setVisualElements();
         textClock.setText("Connecting bluetooth...");
         textClock.setTextColor(Color.WHITE);
+
+        registerReceiver(receiver, intentFilter);
+
+        manager.discoverPeers(channel, new WifiP2pManager.ActionListener() {
+            @Override
+            public void onSuccess() {
+                Log.d("granglawifi","wifi discover");
+            }
+
+            @Override
+            public void onFailure(int reasonCode) {
+                finish();
+                return;
+            }
+        });
     }
 
     public void startGame(){
@@ -264,7 +249,7 @@
 
         table.server = server;
 
-        bluetoothService = new GranglaBluetoothService(granglaSocket, this);
+        //bluetoothService = new GranglaBluetoothService(granglaSocket, this);
 
         tableViewRefreshingThread = new Thread(tableViewRefreshing);
         tableViewRefreshingThread.start();
@@ -388,37 +373,19 @@
         }
     }
 
-    /*@Override
-    protected void onPause() {
-        super.onPause();
-        musicPlayer.mute();
-        gamePaused = true;
-        pausedTime = System.currentTimeMillis();
-        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-        saveSharedPreferences();
-    }*/
-
-
     @Override
     protected void onResume() {
         super.onResume();
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-
-        /*if (musicPlayer == null) {
-            musicPlayer = new MusicPlayer();
-        }
-
-        if (!muted && !musicPlayer.isEndSong()) {
-            musicPlayer = new MusicPlayer();
-            musicPlayerThread = new Thread(musicPlayer);
-            musicPlayer.setNoteDuration((long) (TableConfig.NOTE_DURATION_FACTOR * waitingTimeCross));
-            musicPlayerThread.start();
-        }
+    }
 
-        if (gamePaused) gameStartTime += System.currentTimeMillis() - pausedTime;
-        gamePaused = false;*/
+    @Override
+    public void onPause() {
+        super.onPause();
+        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
+        //unregisterReceiver(receiver);
+        //finish();
     }
-
 
     private void saveSharedPreferences() {
         if (mPrefs == null) {
@@ -574,29 +541,56 @@
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
 
-        this.requestPermissions(new String[]{Manifest.permission.BLUETOOTH,
-                Manifest.permission.BLUETOOTH_ADMIN,
-                Manifest.permission.ACCESS_COARSE_LOCATION,
-                Manifest.permission.ACCESS_FINE_LOCATION,
-                Manifest.permission.BLUETOOTH_CONNECT,
-                Manifest.permission.BLUETOOTH_SCAN
-        }, 1000);
-
-        // Get local Bluetooth adapter
-        mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
-/*
-        // If the adapter is null, then Bluetooth is not supported
-
-        if (mBluetoothAdapter == null) {
-            Toast.makeText(this.getBaseContext(), "Bluetooth is not available", Toast.LENGTH_LONG).show();
-            this.finish();
-        }*/
+        this.requestPermissions(new String[]{permission.NEARBY_WIFI_DEVICES,
+                permission.ACCESS_COARSE_LOCATION,
+                permission.ACCESS_FINE_LOCATION,
+                permission.ACCESS_WIFI_STATE,
+                permission.CHANGE_WIFI_STATE,
+                permission.INTERNET
+        }, PERMISSION_REQUEST_CODE);
 
         currentApiVersion = Build.VERSION.SDK_INT;
         setContentView(R.layout.activity_game_play);
 
+        // Indicates a change in the Wi-Fi Direct status.
+        intentFilter.addAction(WifiP2pManager.WIFI_P2P_STATE_CHANGED_ACTION);
+
+        // Indicates a change in the list of available peers.
+        intentFilter.addAction(WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION);
+
+        // Indicates the state of Wi-Fi Direct connectivity has changed.
+        intentFilter.addAction(WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION);
+
+        // Indicates this device's details have changed.
+        intentFilter.addAction(WifiP2pManager.WIFI_P2P_THIS_DEVICE_CHANGED_ACTION);
 
+        manager = (WifiP2pManager) getSystemService(Context.WIFI_P2P_SERVICE);
+        channel = manager.initialize(this, getMainLooper(), null);
     }
+
+    /*@Override
+    public void onRequestPermissionsResult(int requestCode, String[] permissions,
+                                           int[] grantResults) {
+        switch (requestCode) {
+            case PERMISSION_REQUEST_CODE:
+                // If request is cancelled, the result arrays are empty.
+                if (grantResults.length > 0 &&
+                        grantResults[0] == PackageManager.PERMISSION_GRANTED) {
+                    // Permission is granted. Continue the action or workflow
+                    // in your app.
+                }  else {
+                    // Explain to the user that the feature is unavailable because
+                    // the feature requires a permission that the user has denied.
+                    // At the same time, respect the user's decision. Don't link to
+                    // system settings in an effort to convince the user to change
+                    // their decision.
+                }
+
+                return;
+        }
+        // Other 'case' lines to check for other
+        // permissions this app might request.
+    }*/
 
 
     @Override
@@ -650,7 +644,6 @@
         }
         musicPlayerThread = null;
 
-        mBluetoothAdapter.cancelDiscovery();
         try {
             unregisterReceiver(receiver);
         } catch (IllegalArgumentException e) {
Index: app/src/main/java/com/boardgame/miljac/grangla/SecondMenuActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.boardgame.miljac.grangla;\r\n\r\nimport static com.boardgame.miljac.grangla.music.MusicHelpers.getRandomElement;\r\n\r\nimport android.annotation.SuppressLint;\r\nimport android.app.Activity;\r\nimport android.bluetooth.BluetoothAdapter;\r\nimport android.content.Intent;\r\nimport android.content.res.Configuration;\r\nimport android.os.Build;\r\nimport android.os.Bundle;\r\nimport android.support.v7.app.AppCompatActivity;\r\nimport android.util.Log;\r\nimport android.view.View;\r\nimport android.widget.Toast;\r\n\r\nimport org.billthefarmer.mididriver.GeneralMidiConstants;\r\n\r\nimport java.util.Arrays;\r\n\r\n\r\npublic class SecondMenuActivity extends AppCompatActivity {\r\n    private int currentApiVersion;\r\n    private static final int REQUEST_ENABLE_BT = 3;\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        currentApiVersion = Build.VERSION.SDK_INT;\r\n        setContentView(R.layout.activity_second_menu);\r\n    }\r\n\r\n    @Override\r\n    public void onWindowFocusChanged(boolean hasFocus) {\r\n        super.onWindowFocusChanged(hasFocus);\r\n        setUiFlags();\r\n    }\r\n\r\n\r\n    @Override\r\n    public void onConfigurationChanged(Configuration newConfig) {\r\n        super.onConfigurationChanged(newConfig);\r\n        setUiFlags();\r\n    }\r\n\r\n    @Override\r\n    public void onResume() {\r\n        super.onResume();\r\n        setUiFlags();\r\n    }\r\n\r\n    private void setUiFlags(){\r\n        if (currentApiVersion >= Build.VERSION_CODES.KITKAT)\r\n        {\r\n            getWindow().getDecorView().setSystemUiVisibility(\r\n                    View.SYSTEM_UI_FLAG_LAYOUT_STABLE\r\n                            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\r\n                            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\r\n                            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\r\n                            | View.SYSTEM_UI_FLAG_FULLSCREEN\r\n                            | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);\r\n        }\r\n    }\r\n\r\n    public void beginner(View view) {\r\n        Intent intent = new Intent(this, SinglePlayerGamePlayActivity.class);\r\n        intent.putExtra(\"mrm_LEVEL\", 15);\r\n        intent.putExtra(\"LEVEL_STRING\", \"BEGINNER\");\r\n        intent.putExtra(\"PLAYER1_IMG\", R.drawable.pin42);\r\n        intent.putExtra(\"PLAYER2_IMG\", R.drawable.pin43);\r\n        startActivity(intent);\r\n    }\r\n\r\n    public void intermediate(View view) {\r\n        Intent intent = new Intent(this, SinglePlayerGamePlayActivity.class);\r\n        intent.putExtra(\"mrm_LEVEL\", 55);\r\n        intent.putExtra(\"LEVEL_STRING\", \"MID\");\r\n        intent.putExtra(\"PLAYER1_IMG\", R.drawable.pin42);\r\n        intent.putExtra(\"PLAYER2_IMG\", R.drawable.pin40);\r\n        startActivity(intent);\r\n    }\r\n\r\n    public void expert(View view) {\r\n        Intent intent = new Intent(this, SinglePlayerGamePlayActivity.class);\r\n        intent.putExtra(\"mrm_LEVEL\", 90);\r\n        intent.putExtra(\"LEVEL_STRING\", \"EXPERT\");\r\n        intent.putExtra(\"PLAYER1_IMG\", R.drawable.pin42);\r\n        intent.putExtra(\"PLAYER2_IMG\", R.drawable.pin39);\r\n        startActivity(intent);\r\n    }\r\n\r\n    @SuppressLint(\"MissingPermission\")\r\n    public void bluetooth(View view) {\r\n        BluetoothAdapter mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();\r\n\r\n        // If the adapter is null, then Bluetooth is not supported\r\n\r\n        if (mBluetoothAdapter == null) {\r\n            Toast.makeText(this.getBaseContext(), getResources().getString(R.string.bluetooth_not_available), Toast.LENGTH_LONG).show();\r\n            return;\r\n        }\r\n\r\n        mBluetoothAdapter.setName(\"grangla\");\r\n        if (!mBluetoothAdapter.isEnabled()) {\r\n            /*Intent enableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);\r\n            startActivityForResult(enableIntent, REQUEST_ENABLE_BT);*/\r\n            mBluetoothAdapter.enable();\r\n        }\r\n            /*Intent intent = new Intent(this, BluetoothPlayerGamePlayActivity.class);\r\n            intent.putExtra(\"PLAYER1_IMG\", R.drawable.pin40);\r\n            intent.putExtra(\"PLAYER2_IMG\", R.drawable.pin43);*/\r\n\r\n            Intent discoverableIntent =\r\n                    new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);\r\n            discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 30);\r\n            //startActivity(discoverableIntent);\r\n            startActivityForResult(discoverableIntent, 5);\r\n\r\n            //startActivity(intent);\r\n    }\r\n\r\n    @SuppressLint(\"MissingPermission\")\r\n    public void onActivityResult(int requestCode, int resultCode, Intent data) {\r\n        switch (requestCode) {\r\n            case REQUEST_ENABLE_BT:\r\n                // When the request to enable Bluetooth returns\r\n                if (resultCode == Activity.RESULT_OK) {\r\n                    // Bluetooth is now enabled, so set up a chat session\r\n\r\n\r\n                    Intent discoverableIntent =\r\n                            new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);\r\n                    discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 30);\r\n                    //startActivity(discoverableIntent);\r\n                    startActivityForResult(discoverableIntent, 5);\r\n\r\n                } else {\r\n                    // User did not enable Bluetooth or an error occurred\r\n                    Log.d(\"grangla\", \"BT not enabled\");\r\n                    return;\r\n                }\r\n                break;\r\n            case 5:\r\n                Intent intent = new Intent(this, BluetoothPlayerGamePlayActivity.class);\r\n                intent.putExtra(\"PLAYER1_IMG\", R.drawable.pin42);\r\n                intent.putExtra(\"PLAYER2_IMG\",\r\n                        (int)getRandomElement(Arrays.asList(\r\n                                R.drawable.pin43,\r\n                                R.drawable.pin40,\r\n                                R.drawable.pin39)));\r\n                startActivityForResult(intent, 55);\r\n                break;\r\n            case 55:\r\n                if (resultCode == 55)\r\n                    Toast.makeText(getApplicationContext(),getResources().getString(R.string.bluetooth_connection_failed),Toast.LENGTH_LONG).show();\r\n                if (resultCode == 54)\r\n                    Toast.makeText(getApplicationContext(),getResources().getString(R.string.player_left),Toast.LENGTH_LONG).show();\r\n\r\n        }\r\n    }\r\n\r\n    public void customLevel(View view) {\r\n        Intent intent = new Intent(this, SinglePlayerMenuActivity.class);\r\n        startActivity(intent);\r\n    }\r\n\r\n    public void highScores(View view) {\r\n        Intent intent = new Intent(this, HighScoresActivity.class);\r\n        startActivity(intent);\r\n    }\r\n\r\n    public void exit(View view) {\r\n        this.finish();\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/boardgame/miljac/grangla/SecondMenuActivity.java b/app/src/main/java/com/boardgame/miljac/grangla/SecondMenuActivity.java
--- a/app/src/main/java/com/boardgame/miljac/grangla/SecondMenuActivity.java	(revision 4125073d686ed5e4008d23ffa629e652f1e331ea)
+++ b/app/src/main/java/com/boardgame/miljac/grangla/SecondMenuActivity.java	(date 1673538323797)
@@ -21,7 +21,6 @@
 
 public class SecondMenuActivity extends AppCompatActivity {
     private int currentApiVersion;
-    private static final int REQUEST_ENABLE_BT = 3;
 
     @Override
     protected void onCreate(Bundle savedInstanceState) {
@@ -91,72 +90,14 @@
 
     @SuppressLint("MissingPermission")
     public void bluetooth(View view) {
-        BluetoothAdapter mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
-
-        // If the adapter is null, then Bluetooth is not supported
-
-        if (mBluetoothAdapter == null) {
-            Toast.makeText(this.getBaseContext(), getResources().getString(R.string.bluetooth_not_available), Toast.LENGTH_LONG).show();
-            return;
-        }
-
-        mBluetoothAdapter.setName("grangla");
-        if (!mBluetoothAdapter.isEnabled()) {
-            /*Intent enableIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
-            startActivityForResult(enableIntent, REQUEST_ENABLE_BT);*/
-            mBluetoothAdapter.enable();
-        }
-            /*Intent intent = new Intent(this, BluetoothPlayerGamePlayActivity.class);
-            intent.putExtra("PLAYER1_IMG", R.drawable.pin40);
-            intent.putExtra("PLAYER2_IMG", R.drawable.pin43);*/
-
-            Intent discoverableIntent =
-                    new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);
-            discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 30);
-            //startActivity(discoverableIntent);
-            startActivityForResult(discoverableIntent, 5);
-
-            //startActivity(intent);
-    }
-
-    @SuppressLint("MissingPermission")
-    public void onActivityResult(int requestCode, int resultCode, Intent data) {
-        switch (requestCode) {
-            case REQUEST_ENABLE_BT:
-                // When the request to enable Bluetooth returns
-                if (resultCode == Activity.RESULT_OK) {
-                    // Bluetooth is now enabled, so set up a chat session
-
-
-                    Intent discoverableIntent =
-                            new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE);
-                    discoverableIntent.putExtra(BluetoothAdapter.EXTRA_DISCOVERABLE_DURATION, 30);
-                    //startActivity(discoverableIntent);
-                    startActivityForResult(discoverableIntent, 5);
-
-                } else {
-                    // User did not enable Bluetooth or an error occurred
-                    Log.d("grangla", "BT not enabled");
-                    return;
-                }
-                break;
-            case 5:
-                Intent intent = new Intent(this, BluetoothPlayerGamePlayActivity.class);
-                intent.putExtra("PLAYER1_IMG", R.drawable.pin42);
-                intent.putExtra("PLAYER2_IMG",
-                        (int)getRandomElement(Arrays.asList(
-                                R.drawable.pin43,
-                                R.drawable.pin40,
-                                R.drawable.pin39)));
-                startActivityForResult(intent, 55);
-                break;
-            case 55:
-                if (resultCode == 55)
-                    Toast.makeText(getApplicationContext(),getResources().getString(R.string.bluetooth_connection_failed),Toast.LENGTH_LONG).show();
-                if (resultCode == 54)
-                    Toast.makeText(getApplicationContext(),getResources().getString(R.string.player_left),Toast.LENGTH_LONG).show();
-
-        }
+        Intent intent = new Intent(this, BluetoothPlayerGamePlayActivity.class);
+        intent.putExtra("PLAYER1_IMG", R.drawable.pin42);
+        intent.putExtra("PLAYER2_IMG",
+                (int)getRandomElement(Arrays.asList(
+                        R.drawable.pin43,
+                        R.drawable.pin40,
+                        R.drawable.pin39)));
+        startActivityForResult(intent, 55);
     }
 
     public void customLevel(View view) {
